- block:

    - name: container facts
      set_fact:
        containerName: "mfsMeta2"
        containerHostname: "{{ inventory_hostname }}"
        containerHostIP: "{{ ansible_host }}"
        containerImage: akhlakm/mfsmeta

    - name: metalogger running 
      shell: "docker inspect {{ containerName }}"
      register: cmd_result
      failed_when: "cmd_result.rc != 0"
      changed_when: false

  rescue:

    - name: remove old container
      shell: "docker rm {{ containerName }}"
      ignore_errors: true

    - name: metalogger dockerfiles
      copy:
        src: MetaLogger
        dest: /tmp/
        mode: 0744

    - name: container /etc/hosts
      copy:
        # this file will be generated by ./setup.sh
        src: "{{ playbook_dir }}/etc_hosts"
        dest: /tmp/MetaLogger/etc_hosts

    - name: metalogger config
      template:
        src: mfsmetalogger.cfg
        dest: /tmp/MetaLogger/mfsmetalogger.cfg
        owner: root
        mode: 0744

    - name: meta mount dir exists
      file:
        path: /root/mfsMeta
        state: directory

    - name: docker build
      shell:
        cmd: "docker build -t {{ containerImage }} MetaLogger"
        chdir: /tmp
      register: cmd_result
      failed_when: "cmd_result.rc != 0"

    - name: docker run
      shell:
        cmd: >
          docker run -td
          -v /root/mfsMeta:/var/lib/mfs
          --hostname="{{ containerHostname }}"
          --name="{{ containerName }}"
          "{{ containerImage }}"

      register: cmd_result
      failed_when: "cmd_result.rc != 0"
